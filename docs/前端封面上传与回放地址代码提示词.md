## 前端封面上传与回放地址代码提示词（对齐后端规范）

本提示词基于后端文档“直播核心服务增加封面上传和回放地址功能”，用于指导前端以最小改动集成：
- 上传直播间封面：`POST /api/v1/rooms/{room_id}/cover`（multipart/form-data，字段名 `file`，JWT 鉴权）
- 获取场次回放地址：`GET /api/v1/sessions/{session_id}` 返回 `data.playback_url`（仅当 `status=ready` 且存在 `video_id`）

前端技术栈：uni-app + 自封装 `request` + JWT；基础地址：`BASE_API_URL = http://localhost:8000/api/v1`（已在项目中配置）。

---

### 1. 封面上传（uni.uploadFile 方案，推荐）

目标：选择本地图片，向后端发起 `multipart/form-data` 上传，请求头携带 `Authorization: Bearer <JWT>`。

```ts
// 用于『代码生成』或『直接复制粘贴』的提示词
// 场景：用户在房间设置/创建页面更新封面

// 步骤：
// 1) 选择图片（跨端统一）
// 2) 从 auth store 读取 JWT
// 3) 组装上传 URL：{BASE_API_URL}/rooms/{room_id}/cover
// 4) 使用 uni.uploadFile 发起上传，name 必须为 'file'
// 5) 解析统一响应结构，成功后得到 data.cover_url

import { getToken } from '@/store/auth';
import { BASE_API_URL } from '@/constants/api';

export function uploadRoomCover(roomId: string) {
  return new Promise<string>((resolve, reject) => {
    uni.chooseImage({
      count: 1,
      success: (chooseRes) => {
        const filePath = chooseRes.tempFilePaths?.[0];
        if (!filePath) {
          uni.showToast({ title: '未选择文件', icon: 'none' });
          return reject(new Error('no_file_selected'));
        }

        // 可选：前置校验（大小/类型）——后端已校验，此处仅做用户友好提示
        // 注意：不同端获取文件大小/类型的方式不同，这里略过跨端细节

        const token = getToken();
        const uploadUrl = `${BASE_API_URL.replace(/\/+$/, '')}/rooms/${roomId}/cover`;

        uni.uploadFile({
          url: uploadUrl,
          filePath,
          name: 'file', // 与后端 UploadFile = File(...) 对齐
          header: {
            Authorization: `Bearer ${token || ''}`,
          },
          success: (res) => {
            try {
              const body = JSON.parse(res.data || '{}');
              if (res.statusCode >= 200 && res.statusCode < 300 && body?.code === 0) {
                const coverUrl = body?.data?.cover_url as string;
                uni.showToast({ title: '上传成功', icon: 'success' });
                return resolve(coverUrl);
              }
              uni.showToast({ title: body?.message || `上传失败(${res.statusCode})`, icon: 'none' });
              reject(new Error(body?.message || 'upload_failed'));
            } catch (e) {
              uni.showToast({ title: '响应解析失败', icon: 'none' });
              reject(new Error('parse_failed'));
            }
          },
          fail: (err) => {
            uni.showToast({ title: err?.errMsg || '上传失败', icon: 'none' });
            reject(err);
          },
        });
      },
      fail: (err) => reject(err),
    });
  });
}
```

使用方式：
```ts
// e.g. 在页面中触发
const url = await uploadRoomCover(roomId);
// 1) 直接用返回的 cover_url 刷新 UI
// 2) 或重新拉取房间详情/列表（后端已在响应中增加 cover_url 字段）
```

---

### 2. 封面上传（H5 原生 fetch + FormData 方案，可选）

仅在 H5 浏览器端使用，不走 `uni.uploadFile`：

```ts
import { getToken } from '@/store/auth';
import { BASE_API_URL } from '@/constants/api';

export async function uploadRoomCoverWeb(roomId: string) {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';

  return new Promise<string>((resolve, reject) => {
    input.onchange = async () => {
      const file = input.files?.[0];
      if (!file) return reject(new Error('no_file_selected'));

      // 可选：前置校验大小/类型

      const token = getToken();
      const url = `${BASE_API_URL.replace(/\/+$/, '')}/rooms/${roomId}/cover`;
      const form = new FormData();
      form.append('file', file);

      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: { Authorization: `Bearer ${token || ''}` },
          body: form,
        });
        const body = await resp.json();
        if (resp.ok && body?.code === 0) {
          return resolve(body?.data?.cover_url as string);
        }
        reject(new Error(body?.message || 'upload_failed'));
      } catch (e) {
        reject(e as Error);
      }
    };
    input.click();
  });
}
```

---

### 3. 获取回放地址并播放

后端在 `GET /api/v1/sessions/{session_id}` 的响应中动态增加 `data.playback_url`：

```ts
import { getSessionDetail } from '@/api/session';

export async function loadPlaybackUrl(sessionId: string) {
  const res = await getSessionDetail(sessionId);
  // 统一响应结构：{ code, message, data, timestamp }
  if (!res || (res as any).code !== 0) throw new Error((res as any)?.message || 'load_failed');
  const session = (res as any).data;
  return session?.playback_url as string | null; // 仅当 status=ready 且 video_id 存在时返回非空
}

// 传入 HLS 播放页面（示例：public/hls-player.html）
export function openHlsPlayer(playbackUrl: string) {
  if (!playbackUrl) {
    uni.showToast({ title: '暂无回放', icon: 'none' });
    return;
  }
  const url = `/hls-player.html?url=${encodeURIComponent(playbackUrl)}`;
  // H5:
  if (typeof window !== 'undefined') {
    window.open(url, '_blank');
  } else {
    // 其他端可用 web-view 或内置浏览器
    uni.navigateTo({ url });
  }
}
```

---

### 4. 约束与错误处理要点（与后端规范对齐）

- 文件限制：仅 `jpg/jpeg/png/gif`，大小 ≤ 5MB；上传失败消息优先显示后端返回 `message`。
- 鉴权：请求头 `Authorization: Bearer <JWT>`；401/403 触发现有的重新登录/无权提示逻辑。
- 成功响应：遵循 `{ code, message, data, timestamp }`；封面上传成功返回 `data.cover_url`。
- 回放地址：仅当 `status=ready` 且存在 `video_id` 时，`data.playback_url` 才为非空；否则为 `null`。

---

### 5. 与现有项目集成建议

- 基础地址：已在 `src/config/env.ts` 与 `vite.config.ts` 设置为本地 `http://localhost:8000/api/v1`（开发环境）。
- 列表/详情页：后端会在房间列表/详情响应中增加 `cover_url` 字段；上传成功后可直接刷新对应数据源或更新本地 store。
- HLS：如需本地测试 HLS，请确保有本地可访问的 m3u8 播放地址，或调整 `vite.config.ts` 中相关代理。

---

以上代码段可直接用于生成器提示或拷贝使用，保持与后端接口及项目当前配置严格一致。


